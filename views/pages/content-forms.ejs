<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forms - <%= process.env.APP_NAME || 'ValEdit' %></title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="/public/css/dashboard.css?v=1" rel="stylesheet" />
    <style>
      .form-element {
        cursor: grab;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .form-element:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .form-element:active {
        cursor: grabbing;
      }
      .drop-zone {
        min-height: 400px;
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      .drop-zone.drag-over {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }
      .dropped-element {
        margin: 8px 0;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: white;
        position: relative;
      }
      .dropped-element:hover .element-controls {
        opacity: 1;
      }
      .element-controls {
        position: absolute;
        top: 4px;
        right: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .form-preview {
        max-height: 600px;
        overflow-y: auto;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .tab-button {
        transition: all 0.2s;
      }
      .tab-button.active {
        background-color: #3b82f6;
        color: white;
      }
      .form-card {
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .form-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Tailwind Megamenu -->
    <%- include('../partials/tailwind-megamenu') %>

    <!-- Main Content -->
    <main class="w-full px-2 py-8">
      <div class="bg-white rounded-lg shadow-lg w-full">
        <!-- Header with Tabs -->
        <div class="border-b border-gray-200">
          <div class="flex justify-between items-center p-6 pb-4">
            <div>
              <h1 class="text-3xl font-bold text-gray-800">Forms Management</h1>
              <p class="text-gray-600 mt-1">
                Manage and create forms for your website
              </p>
            </div>
          </div>

          <!-- Tab Navigation -->
          <div class="px-6">
            <div class="flex space-x-1 mb-0">
              <button
                id="formsListTab"
                class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-transparent hover:text-blue-600 active"
                onclick="switchTab('formsList')"
              >
                <i class="fas fa-list mr-2"></i>My Forms
              </button>
              <button
                id="formBuilderTab"
                class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-transparent hover:text-blue-600"
                onclick="switchTab('formBuilder')"
              >
                <i class="fas fa-plus mr-2"></i>Create New Form
              </button>
            </div>
          </div>
        </div>

        <!-- Forms List Tab -->
        <div id="formsListContent" class="tab-content active p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-800">Your Forms</h2>
            <button
              onclick="switchTab('formBuilder')"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center"
            >
              <i class="fas fa-plus mr-2"></i>Create New Form
            </button>
          </div>

          <!-- Forms Grid -->
          <div
            id="formsGrid"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          >
            <!-- Forms will be loaded here -->
          </div>

          <!-- Empty State -->
          <div id="emptyState" class="text-center py-12 hidden">
            <div class="text-gray-400 mb-4">
              <i class="fas fa-wpforms text-6xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No forms yet</h3>
            <p class="text-gray-500 mb-6">
              Create your first form to get started
            </p>
            <button
              onclick="switchTab('formBuilder')"
              class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200"
            >
              <i class="fas fa-plus mr-2"></i>Create Your First Form
            </button>
          </div>
        </div>

        <!-- Form Builder Tab -->
        <div id="formBuilderContent" class="tab-content">
          <div
            class="flex justify-between items-center p-6 border-b border-gray-200"
          >
            <div>
              <h2 class="text-xl font-semibold text-gray-800">Form Builder</h2>
              <p class="text-gray-600 mt-1">
                Drag and drop elements to create your form
              </p>
            </div>
            <div class="flex gap-3">
              <button
                id="backToListBtn"
                class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200 flex items-center"
                onclick="switchTab('formsList')"
              >
                <i class="fas fa-arrow-left mr-2"></i>Back to Forms
              </button>
              <button
                id="previewBtn"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center"
              >
                <i class="fas fa-eye mr-2"></i>Preview
              </button>
              <button
                id="saveBtn"
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center"
              >
                <i class="fas fa-save mr-2"></i>Save Form
              </button>
            </div>
          </div>

          <div class="flex h-[calc(100vh-280px)]">
            <!-- Left Sidebar - Form Elements -->
            <div class="w-64 p-6 border-r border-gray-200 bg-gray-50">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">
                Form Elements
              </h3>
              <div class="space-y-3">
                <!-- Text Input -->
                <div
                  class="form-element bg-white p-3 rounded-lg border border-gray-200 cursor-grab"
                  draggable="true"
                  data-type="text"
                >
                  <div class="flex items-center">
                    <i class="fas fa-font text-blue-600 mr-2"></i>
                    <span class="text-sm font-medium">Text Input</span>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    Single line text field
                  </div>
                </div>

                <!-- Textarea -->
                <div
                  class="form-element bg-white p-3 rounded-lg border border-gray-200 cursor-grab"
                  draggable="true"
                  data-type="textarea"
                >
                  <div class="flex items-center">
                    <i class="fas fa-align-left text-green-600 mr-2"></i>
                    <span class="text-sm font-medium">Textarea</span>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    Multi-line text field
                  </div>
                </div>

                <!-- Email Input -->
                <div
                  class="form-element bg-white p-3 rounded-lg border border-gray-200 cursor-grab"
                  draggable="true"
                  data-type="email"
                >
                  <div class="flex items-center">
                    <i class="fas fa-envelope text-purple-600 mr-2"></i>
                    <span class="text-sm font-medium">Email</span>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    Email input field
                  </div>
                </div>

                <!-- Select Dropdown -->
                <div
                  class="form-element bg-white p-3 rounded-lg border border-gray-200 cursor-grab"
                  draggable="true"
                  data-type="select"
                >
                  <div class="flex items-center">
                    <i class="fas fa-list text-orange-600 mr-2"></i>
                    <span class="text-sm font-medium">Select</span>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    Dropdown selection
                  </div>
                </div>

                <!-- Checkbox -->
                <div
                  class="form-element bg-white p-3 rounded-lg border border-gray-200 cursor-grab"
                  draggable="true"
                  data-type="checkbox"
                >
                  <div class="flex items-center">
                    <i class="fas fa-check-square text-indigo-600 mr-2"></i>
                    <span class="text-sm font-medium">Checkbox</span>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">Single checkbox</div>
                </div>

                <!-- Radio Group -->
                <div
                  class="form-element bg-white p-3 rounded-lg border border-gray-200 cursor-grab"
                  draggable="true"
                  data-type="radio"
                >
                  <div class="flex items-center">
                    <i class="fas fa-dot-circle text-red-600 mr-2"></i>
                    <span class="text-sm font-medium">Radio Group</span>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">Multiple choice</div>
                </div>

                <!-- Submit Button -->
                <div
                  class="form-element bg-white p-3 rounded-lg border border-gray-200 cursor-grab"
                  draggable="true"
                  data-type="submit"
                >
                  <div class="flex items-center">
                    <i class="fas fa-paper-plane text-green-600 mr-2"></i>
                    <span class="text-sm font-medium">Submit Button</span>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">Form submission</div>
                </div>
              </div>
            </div>

            <!-- Main Form Builder Area -->
            <div class="flex-1 p-6">
              <div class="h-full">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-semibold text-gray-800">
                    Form Canvas
                  </h3>
                  <button
                    id="clearBtn"
                    class="text-red-600 hover:text-red-800 text-sm"
                  >
                    <i class="fas fa-trash mr-1"></i>Clear Form
                  </button>
                </div>

                <!-- Form Name Input -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Form Name</label
                  >
                  <input
                    type="text"
                    id="formName"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter form name..."
                    value="Untitled Form"
                  />
                </div>

                <!-- Drop Zone -->
                <div
                  id="dropZone"
                  class="drop-zone flex flex-col items-center justify-center p-8 bg-gray-50"
                >
                  <div class="text-center text-gray-500">
                    <i class="fas fa-mouse-pointer text-4xl mb-4"></i>
                    <p class="text-lg">
                      Drag form elements here to build your form
                    </p>
                    <p class="text-sm mt-2">
                      Elements will appear in the order you drop them
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Sidebar - Properties Panel -->
            <div class="w-64 p-6 border-l border-gray-200 bg-gray-50">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">
                Properties
              </h3>
              <div id="propertiesPanel" class="text-gray-500 text-sm">
                <p>Select an element to edit its properties</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Form Preview Modal -->
    <div
      id="previewModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"
    >
      <div class="flex items-center justify-center h-full p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
          <div class="flex justify-between items-center p-6 border-b">
            <h2 class="text-xl font-bold">Form Preview</h2>
            <button id="closePreview" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="p-6 form-preview">
            <div id="previewContent"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Test Form Modal -->
    <div
      id="testFormModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"
    >
      <div class="flex items-center justify-center h-full p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
          <div class="flex justify-between items-center p-6 border-b">
            <h2 class="text-xl font-bold">Test Form Submission</h2>
            <button id="closeTestModal" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="p-6">
            <div class="mb-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Email Options</h3>
              <div class="space-y-4">
                <div>
                  <label class="flex items-center">
                    <input type="radio" name="emailOption" value="form" class="mr-3" checked>
                    <span class="text-sm">Use form's configured email addresses</span>
                  </label>
                  <div id="formEmailAddresses" class="ml-6 mt-2 text-sm text-gray-600">
                    <!-- Form email addresses will be displayed here -->
                  </div>
                </div>
                <div>
                  <label class="flex items-start">
                    <input type="radio" name="emailOption" value="custom" class="mr-3 mt-1">
                    <div class="flex-1">
                      <span class="text-sm">Use custom test email address</span>
                      <input 
                        type="email" 
                        id="customTestEmail" 
                        class="w-full mt-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                        placeholder="test@example.com"
                        disabled
                      >
                    </div>
                  </label>
                </div>
              </div>
            </div>
            
            <div class="mb-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Test Form</h3>
              <div id="testFormContent" class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                <!-- Form content will be rendered here -->
              </div>
            </div>
            
            <div class="flex justify-end space-x-3">
              <button 
                id="cancelTestBtn" 
                class="px-4 py-2 bg-gray-300 text-gray-700 text-sm font-medium rounded hover:bg-gray-400"
              >
                Cancel
              </button>
              <button 
                id="submitTestBtn" 
                class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700"
              >
                <i class="fas fa-paper-plane mr-2"></i>Submit Test
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Card Template (Hidden) -->
    <template id="formCardTemplate">
      <div
        class="form-card bg-white p-6 rounded-lg shadow-md border hover:shadow-lg"
      >
        <div class="flex justify-between items-start mb-4">
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-gray-900 form-title"></h3>
            <p class="text-sm text-gray-500 form-description"></p>
          </div>
          <div class="flex items-center space-x-2">
            <span
              class="form-status-badge px-2 py-1 text-xs font-medium rounded-full"
            ></span>
          </div>
        </div>

        <div
          class="flex justify-between items-center text-sm text-gray-500 mb-4"
        >
          <div class="flex items-center">
            <i class="fas fa-calendar mr-2"></i>
            <span class="form-date"></span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-paper-plane mr-2"></i>
            <span class="form-submissions"></span> submissions
          </div>
        </div>

        <div
          class="flex justify-between items-center pt-4 border-t border-gray-200"
        >
          <div class="flex space-x-2">
            <button
              class="edit-form-btn text-blue-600 hover:text-blue-800 text-sm font-medium"
            >
              <i class="fas fa-edit mr-1"></i>Edit
            </button>
            <button
              class="view-submissions-btn text-green-600 hover:text-green-800 text-sm font-medium"
            >
              <i class="fas fa-eye mr-1"></i>Submissions
            </button>
            <button
              class="test-form-btn text-orange-600 hover:text-orange-800 text-sm font-medium"
            >
              <i class="fas fa-vial mr-1"></i>Test
            </button>
            <button
              class="publish-toggle-btn text-purple-600 hover:text-purple-800 text-sm font-medium"
            >
              <i class="fas fa-globe mr-1"></i
              ><span class="publish-text">Publish</span>
            </button>
          </div>
          <button
            class="delete-form-btn text-red-600 hover:text-red-800 text-sm"
          >
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </template>

    <!-- JavaScript -->
    <script src="/public/js/frontend-logger.js"></script>
    <script src="/public/js/notifications.js"></script>
    <script src="/public/js/forms.js"></script>

    <script>
      // Tab switching functionality
      function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        // Remove active class from all tab buttons
        document.querySelectorAll(".tab-button").forEach((button) => {
          button.classList.remove("active");
        });

        // Show selected tab content
        const targetContent = document.getElementById(tabName + "Content");
        const targetButton = document.getElementById(tabName + "Tab");

        if (targetContent) {
          targetContent.classList.add("active");
        }

        if (targetButton) {
          targetButton.classList.add("active");
        }

        // Trigger custom event for tab change
        window.dispatchEvent(
          new CustomEvent("tabChanged", { detail: tabName })
        );

        // For form builder tab, initialize elements
        if (tabName === "formBuilder") {
          // Small delay to ensure DOM is fully updated
          setTimeout(() => {
            if (typeof window.switchToBuilder === "function") {
              window.switchToBuilder();
            }
          }, 100);
        }

        // For forms list tab, load existing forms
        if (tabName === "formsList") {
          // Small delay to ensure DOM is fully updated
          setTimeout(() => {
            loadExistingForms();
          }, 100);
        }
      }

      // Tab change event listener removed to prevent infinite loop
      // The switchTab function already handles initialization

      // Load existing forms when DOM is ready
      document.addEventListener("DOMContentLoaded", function () {
        // Check which tab is active initially
        const activeTab = document.querySelector(".tab-content.active");
        if (activeTab && activeTab.id === "formsListContent") {
          loadExistingForms();
        }
      });
    </script>
  </body>
</html>
